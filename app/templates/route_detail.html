{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>{{ route.name }}</h1>
  <div>
    <span class="badge bg-{{ 'success' if route.status == 'CONFIRMED' else 'secondary' }} me-2">{{ route.status }}</span>
    <span class="text-muted">Assigned to {{ route.assigned_user.name }}</span>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Optimized Stops</h5>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Store</th>
                <th>Travel</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody>
              {% for stop in route.stops|sort(attribute='sequence') %}
              <tr>
                <td>{{ stop.sequence }}</td>
                <td>
                  <a href="/stores/{{ stop.store.id }}">{{ stop.store.display_name }}</a><br />
                  <span class="text-muted small">{{ stop.store.city }}, {{ stop.store.province }}</span>
                </td>
                <td>{{ '%.1f km'|format(stop.travel_distance_km) }} / {{ '%.0f mins'|format(stop.travel_minutes) }}</td>
                <td>
                  {% if can_edit %}
                  <textarea class="form-control" name="comments" form="route-update" rows="2">{{ stop.comments or '' }}</textarea>
                  <input type="hidden" name="comment_store_ids" form="route-update" value="{{ stop.store_id }}" />
                  {% else %}
                  {{ stop.comments or '—' }}
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr><td colspan="4">Add stores to this route to begin planning.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Route Summary</h5>
        <p class="mb-1"><strong>Stops:</strong> {{ route.stops|length }}</p>
        <p class="mb-1"><strong>Total Distance:</strong> {{ '%.1f km'|format(route.total_distance_km) }}</p>
        <p class="mb-3"><strong>Estimated Travel:</strong> {{ '%.0f mins'|format(route.total_travel_minutes) }}</p>
        <p class="small text-muted mb-0">Notes: {{ route.notes or '—' }}</p>
      </div>
    </div>
    {% if can_edit %}
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Edit Route</h5>
        <form id="route-update" method="post" action="/routes/{{ route.id }}/update">
          <input type="hidden" name="action" value="save" />
          <div class="mb-2">
            <label class="form-label">Route Name</label>
            <input class="form-control" type="text" name="name" value="{{ route.name }}" required />
          </div>
          <div class="mb-2">
            <label class="form-label">Planned Date</label>
            <input class="form-control" type="date" name="planned_date" value="{{ route.planned_date }}" />
          </div>
          <div class="mb-2">
            <label class="form-label">Assign To</label>
            <select class="form-select" name="assigned_user_id">
              {% for teammate in assignable_users %}
              <option value="{{ teammate.id }}" {% if teammate.id == route.assigned_user_id %}selected{% endif %}>{{ teammate.name }} ({{ teammate.role }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Route Notes</label>
            <textarea class="form-control" name="notes" rows="2">{{ route.notes or '' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Included Stores</label>
            {% set stop_store_ids = route.stops|map(attribute='store_id')|list %}
            <select class="form-select" name="store_ids" multiple size="8">
              {% for store in available_stores %}
              <option value="{{ store.id }}" {% if store.id in stop_store_ids %}selected{% endif %}>
                {{ store.display_name }} — {{ store.city }}, {{ store.province }}
              </option>
              {% endfor %}
            </select>
            <div class="form-text">Re-select stores to add or remove stops. The optimized order will refresh automatically.</div>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <div class="btn-group" role="group">
              <button class="btn btn-primary" type="submit" name="action" value="save">Save Changes</button>
              <button class="btn btn-outline-secondary" type="submit" name="action" value="reoptimize">Re-optimize</button>
            </div>
            {% if user.role == 'ADMIN' or user.id == route.assigned_user_id %}
            <button class="btn btn-success ms-auto" type="submit" name="action" value="confirm">Confirm Route</button>
            {% endif %}
          </div>
          <div class="form-text mt-2">Confirming locks the route. Only the assigned salesperson or an admin can confirm.</div>
        </form>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">Route updates are locked because this plan has been confirmed.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
