{% extends 'base.html' %}
{% block content %}
<h1 class="mb-3">Store Map</h1>
<div class="row">
  <div class="col-md-9">
    <div id="map" style="height: 600px"></div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h5>Marker Legend</h5>
        <ul class="list-unstyled">
          <li><span class="legend-dot status-lead"></span> Lead</li>
          <li><span class="legend-dot status-active"></span> Active</li>
          <li><span class="legend-dot status-dormant"></span> Dormant</li>
          <li><span class="legend-dot status-closed"></span> Closed</li>
        </ul>
        <p class="small text-muted">Franchise-assigned stores use their franchise color for quick visual grouping.</p>
      </div>
    </div>
  </div>
</div>
{% if user.role in ['ADMIN', 'SALESMAN'] %}
<div class="card mt-4">
  <div class="card-body">
    <h5>Add Store via Place Search</h5>
    <form method="post" action="/stores/new">
      <div class="row g-2">
        <div class="col-md-4">
          <input class="form-control" type="text" name="display_name" placeholder="Store name" required />
        </div>
        <div class="col-md-3">
          <input class="form-control" type="text" name="city" placeholder="City" required />
        </div>
        <div class="col-md-2">
          <input class="form-control" type="text" name="province" placeholder="Province" required />
        </div>
        <div class="col-md-3">
          <input class="form-control" type="text" name="address1" placeholder="Address" />
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <input class="form-control" type="text" name="google_place_id" placeholder="Google Place ID" />
        </div>
        <div class="col-md-4">
          <input class="form-control" type="number" step="0.000001" name="latitude" placeholder="Latitude" />
        </div>
        <div class="col-md-4">
          <input class="form-control" type="number" step="0.000001" name="longitude" placeholder="Longitude" />
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Save Store</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
  const statusColors = {
    LEAD: 'blue',
    ACTIVE: 'green',
    DORMANT: 'orange',
    CLOSED: 'red'
  };
  async function initMap() {
    const response = await fetch('/api/stores.geojson');
    const data = await response.json();
    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 5,
      center: { lat: 53.7267, lng: -127.6476 },
    });
    const infoWindow = new google.maps.InfoWindow();
    const markers = data.features.map(feature => {
      const { coordinates } = feature.geometry;
      const fillColor = feature.properties.franchise_color || statusColors[feature.properties.status] || 'gray';
      const marker = new google.maps.Marker({
        position: { lat: coordinates[1], lng: coordinates[0] },
        map,
        title: feature.properties.name,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: fillColor,
          fillOpacity: 0.9,
          strokeColor: 'white',
          strokeWeight: 1,
          scale: 8,
        },
      });
      marker.addListener('click', () => {
        infoWindow.setContent(`
          <div>
            <strong>${feature.properties.name}</strong><br />
            ${feature.properties.city}, ${feature.properties.province}<br />
            Status: ${feature.properties.status}<br />
            Owner: ${feature.properties.owner || 'Unassigned'}<br />
            Franchise: ${feature.properties.franchise || 'Independent'}
          </div>
        `);
        infoWindow.open({ anchor: marker, map });
      });
      return marker;
    });
    new markerClusterer.MarkerClusterer({ markers, map });
  }
</script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
{% if google_maps_api_key %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
{% else %}
<script>
  document.getElementById('map').innerHTML = '<div class="alert alert-warning m-3">Set GOOGLE_MAPS_API_KEY to view the map.</div>';
</script>
{% endif %}
{% endblock %}
